/* 
    KGrid
    Autor: Nelson Páez,
    Mail: nelpa90@gmail.com,
    Web: www.konecta.com.py
    Versión: 2.3.2
*/
(function(){$.kGrids={instances:{}};$.fn.kGrid=function(c,b){return this.each(function(){if(typeof c=="string"){var d=$.kGrids.instances[this.id];if(d==undefined||d==null){return}switch(c){case"recargar":if(b!=undefined){d.set_data(b)}d.cargar();break;case"pagina":if(b==undefined){return}var h=parseInt(b);if(isNaN(h)){h=0;switch(b){case"primera":h=1;break;case"anterior":h=parseInt(d.pagina)-1;break;case"siguiente":h=parseInt(d.pagina)+1;break;case"ultima":h=d.totalPaginas;break;default:return}}if(h<1||h>parseInt(d.totalPaginas)){return}d.set_data({page:h});d.cargar();break;case"buscar":if(b==undefined){return}var e="AND";if(b.groupOp!=undefined){e=b.groupOp}var g=[];$.each(b.reglas,function(j,i){g.push({field:i.field,data:(i.data!=undefined)?i.data:b.data,op:(i.op!=undefined)?i.op:"cn"})});d.set_data({_search:true,filters:JSON.stringify({groupOp:e,rules:g})});d.set_data({page:1});d.cargar();break;case"seleccionar":d.seleccionar(b);break;case"agregar":d.agregar(b);default:return}}else{var f=new a(this,c);$.kGrids.instances[this.id]=f}})};var a=function(f,b){if(b.url==undefined||b.id==undefined||b.campos==undefined){console.error("Los campos id, url y campos son obligatorios.");return}if(b.ajax==undefined){b.ajax="GET"}if(b.data==undefined){b.data={}}if(b.titulos==undefined){b.titulos=true}if(b.permisos==undefined){b.permisos={}}if(b.retorno==undefined){b.retorno={}}if(b.botones==undefined){b.botones=[]}if(b.paginador==undefined){b.paginador=$("<div>").addClass("text-center").appendTo(f)}var c={_search:false,filters:null,page:1,rows:10,sidx:b.id,sord:"asc",todos:false};if(b.tarjetas){c.rows=5}$.each(b.data,function(g,h){c[g]=h});var d={editar:null,guardar:null,activar:null,remover:null};$.each(b.permisos,function(g,h){d[g]=h});if(b.seleccionable){var e={nombre:"kGrid_seleccionado",titulo:"",ancho:1,atributos:{type:"checkbox",readonly:"false",disabled:"false","class":f.id+"_seleccionar_row"}};b.campos.unshift(e);if(!b.seleccionados){b.seleccionados=[]}}this.div=f;this.url=b.url;this.data=c;this.id=b.id;this.tarjetas=b.tarjetas;this.mostrar_titulos=b.titulos;this.etiquetas=[];this.campos=b.campos;this.ajax=b.ajax;this.permisos=d;this.botones=b.botones;this.estado=b.estado;this.load_complete=b.loadComplete;this.paginador=b.paginador;this.onclick=b.onclick;this.ondblclick=b.ondblclick;this.seleccionable=b.seleccionable;this.seleccionados={};this.preseleccionados=b.seleccionados;this.nuevos=0;this.cargar_estilos();this.cargar_paginador();this.titulos();this.cargar();$(f).on("reloadGrid",function(){$.kGrids.instances[this.id].cargar()})};a.prototype={set_data:function(c){var b=this;$.each(c,function(d,e){b.data[d]=e})},nueva_grilla:function(){var b=this;$(b.div).addClass("kgrid form-horizontal");b.contenido=$("<div>").attr("id",b.div.id+"_grilla").prependTo(b.div);if(b.seleccionable){b.seleccionar(b.preseleccionados)}},nuevo_mensaje:function(c,b){var d=this;if(d.mensaje){d.mensaje.remove()}d.mensaje=$("<div>").attr("role","alert").addClass("alert").addClass(c?c:"alert-info").html(b).prependTo(d.contenido);$("<button>").attr("data-dismiss","alert").addClass("close").attr("type","button").html('<i class="fa fa-times"></i>').appendTo(d.mensaje)},titulos:function(){var b=this;if(b.tarjetas){return}var d=$("<div>").addClass("form-group hidden-xs hidden-sm");var c=$("<div>").addClass("col-md-11").appendTo(d);b.nueva_grilla();$.each(b.campos,function(i,e){var g=$("<h4>");if(e.titulo!=undefined){g.append(e.titulo)}else{g.append(e.nombre)}b.etiquetas.push(g.html());$("<i>").addClass("fa fa-fw fa-arrow-down text-muted").prependTo(g);if(!e.ancho){e.ancho=parseInt(12/b.campos.length)}var f=$("<div>").html(g).addClass("col-md-"+e.ancho).appendTo(c);if(b.seleccionable&&i==0){f.addClass("text-center");var h=$("<input>").attr("id",b.div.id+"_seleccionar_todo").attr("type","checkbox").change(function(){var j=$(this).is(":checked");$("."+b.div.id+"_seleccionar_row").each(function(k,l){$(l).prop("checked",j);$(l).trigger("change")})});g.html(h)}});d.prependTo(b.div);if(!b.mostrar_titulos){d.hide()}},cargar:function(){var b=this;if(b.contenido){b.contenido.empty()}else{b.nueva_grilla()}$.ajax({type:b.ajax,url:b.url,data:b.data,success:function(e){if(!e.error){var d=e.respuesta.datos;var c={};b.totalDatos=e.respuesta.totalDatos;b.pagina=e.respuesta.pagina;b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows);b.grilla=$("<div>").addClass("kGrid").prependTo(b.contenido);$.each(d,function(f,g){c[g[b.id]]=g;b.cargar_entrada(g)});$(b.grilla).find("."+b.div.id+"_seleccionar_row").each(function(f,g){if(b.seleccionados[$(g).data("pk")]){$(g).attr("checked","checked")}$(g).change(function(){b.cambiar_seleccion($(g).data("pk"),$(g).is(":checked"))})});if(b.tarjetas){b.grilla.find(".kscore").each(function(g,h){var f=parseInt($(h).parent().parent().parent().height())*0.8;$(h).css("width",f);$(h).css("height",f)});b.grilla.find(".kacciones,.kscores").each(function(h,f){var g=$(f).parent().parent().height()-$(f).height();var i=$(f).next();if(i.hasClass("kscores")&&!i.is(":empty")){$(f).css("font-size","0.5em")
}else{g=g/2}if(g>0){$(f).css("padding-top",g)}})}$(b.div).data("datos",c);$(b.div).data("totalDatos",b.totalDatos);$(b.div).data("pagina",b.pagina);$(b.div).data("totalPaginas",b.totalPaginas);$("#kGrid_"+b.div.id+"_pagina").val(b.pagina).data("pagina",b.pagina);$("#kGrid_"+b.div.id+"_totalPaginas").html(b.totalPaginas);$("#kGrid_"+b.div.id+"_primera_pagina").attr("disabled",b.pagina==1);$("#kGrid_"+b.div.id+"_pagina_anterior").attr("disabled",b.pagina==1);$("#kGrid_"+b.div.id+"_ultima_pagina").attr("disabled",b.pagina==b.totalPaginas);$("#kGrid_"+b.div.id+"_siguiente_pagina").attr("disabled",b.pagina==b.totalPaginas)}else{if(e.mensaje){b.nuevo_mensaje(e.tipoMensaje,e.mensaje)}}if(typeof b.load_complete=="function"){b.load_complete.call(this,e)}},async:false})},cargar_entrada:function(w){var j=this;var n=w==undefined;var v="kGrid_"+j.div.id+"_"+(n?("nuevo_"+j.nuevos):w[j.id]);if(n){if($("#"+v).is(":visible")){var o=$("#"+v).find("input[data-editando]").first();if(o.length){o.focus()}else{j.nuevos++;j.cargar_entrada(w)}return}if(!j.tarjetas&&j.permisos.guardar){w={}}else{console.error('Para agregar entradas vacías la grilla no debe ser tipo tarjeta y debe configurar el permiso "guardar"');return}}var m=j.tarjetas?function(A,B){A.html(B)}:function(A,B){A.val(B)};var e=$("<div>").attr("id",v).attr("data-pk",w[j.id]).addClass("form-group"+(j.tarjetas?" well":""));var b=n?true:false;if(!n&&typeof j.estado=="function"){b=j.estado.call(this,w)}if(j.onclick){var z=typeof j.onclick=="function"?j.onclick:function(){window.open(j.onclick,"_self")};e.addClass("kbtn").click(function(){z.call(this,w)})}else{if(j.ondblclick){if((typeof j.ondblclick=="function")||(b&&typeof j.permisos.editar=="function")){var k=typeof j.ondblclick=="function"?j.ondblclick:function(){j.permisos.editar.call(this,w)};e.dblclick(function(){k.call(this,w)})}}}var l=$(j.permisos.guardar?"<form>":"<div>").addClass("col-md-"+(j.tarjetas?"7":"11")).appendTo(e);var y=$("<div>").addClass("text-right col-md-"+(j.tarjetas?"5":"1")).appendTo(e);var r=$("<div>").addClass("pull-right").addClass("kacciones").appendTo(y);var t=$("<div>").addClass("kscores pull-right").appendTo(y);$.each(j.campos,function(H,C){var A;if(C.tipo!="score"){var B=C.ancho;var F="<div>";if(j.tarjetas){B=6;F="<p>";if(C.tipo=="destacado"||C.tipo=="encabezado"){B=12}if(C.tipo=="encabezado"){F="<h2>"}}A=$(F).addClass("col-md-"+B).appendTo(l)}else{A=$("<p>").appendTo($("<div>").addClass("text-center pull-left kscore").appendTo(t))}if(!j.tarjetas){var E=$("<label>").addClass("klabel").addClass("visible-xs visible-sm").html(j.etiquetas[H]).appendTo(A)}var D=j.tarjetas?A:$("<input>").addClass("form-control").attr("readonly",true).attr("name",C.nombre).appendTo(A);if(typeof C.formato=="function"){w[C.nombre]=C.formato.call(this,w[C.nombre],w)}m(D,w[C.nombre]);if(j.tarjetas&&C.titulo&&C.titulo!=""){if(C.tipo!="score"){$("<label>").addClass("text-muted").html(C.titulo+"&nbsp; &nbsp;").prependTo(A)}else{$("<br>").appendTo(A);$("<small>").html(C.titulo).appendTo(A)}}if(C.atributos!=undefined){$.each(C.atributos,function(I,J){D.attr(I,J)});var G=["disabled","readonly"];$.each(G,function(I,J){if(C.atributos[J]=="false"){D.removeAttr(J)}D.attr("data-"+J,C.atributos[J])});if(!j.tarjetas&&C.atributos.type=="checkbox"){if(D.val()=="true"){D.attr("checked","checked")}D.removeClass("form-control").attr("data-pk",w[j.id]).dblclick(function(I){I.stopPropagation()});if(D.attr("readonly")){D.attr("disabled","disabled")}D.parent().addClass("text-center")}}});var x=j.tarjetas?"fa-3x":"fa-lg";var p=function(E,B,D,C){var A=$("<a>").attr("id",v+"_"+E).addClass("text-muted kaccion").attr("title",B).attr("href","JavaScript:void(0);").html('<i class="fa '+x+" fa-"+D+'"></i>').hover(function(){$(this).removeClass("text-muted").addClass("text-"+C)},function(){$(this).addClass("text-muted").removeClass("text-"+C)});return A};var i=function(){$("#"+v+" form").find("input[readonly]").each(function(A,B){if(($(B).attr("data-disabled")!="true"&&$(B).attr("data-readonly")!="true")||(n&&$(B).attr("data-creable"))){$(B).removeAttr("readonly").removeAttr("disabled").attr("data-editando",true)}});$("#"+v+"_editar").hide();if(!n){$("#"+v+"_remover").hide();$("#"+v+"_deshacer").fadeIn()}$("#"+v+"_guardar").fadeIn();$("#"+v).find("input[data-editando]").first().focus()};var g=function(){$("#"+v+" form").find("input[data-editando]").each(function(A,B){$(B).attr("readonly",$(B).attr("data-readonly")!="false").removeAttr("data-editando");if($(B).attr("type")=="checkbox"){$(B).attr("disabled",$(B).attr("data-disabled")!="false")}});$("#"+v+"_guardar").hide();$("#"+v+"_deshacer").hide();$("#"+v+"_editar").fadeIn();$("#"+v+"_remover").fadeIn()};var u=function(){var A=$(j.div).data("datos")[$("#"+v).attr("data-pk")];var B=$("#"+v+" form").find("input[data-editando]");g();B.each(function(C,D){if($(D).attr("type")=="checkbox"){$(w).removeAttr("checked");if(j.seleccionados[$(w).data("pk")]){$(w).prop("checked",A[$(D).attr("name")])}}else{$(D).val(A[$(D).attr("name")])
}})};if(b){if(j.permisos.editar){var d=p("editar","Editar","pencil","primary");if(typeof j.permisos.editar=="function"){d.click(function(A){A.stopPropagation();j.permisos.editar.call(this,w)})}else{if(j.permisos.guardar){var f=p("guardar","Guardar","save","primary");f.hide();var h=typeof j.permisos.guardar=="function"?function(A){j.permisos.guardar.call(this,A)}:function(A){$.ajax({type:"POST",url:j.permisos.guardar,data:A,success:function(B){j.cargar()}})};f.click(function(A){A.stopPropagation();g();h($.extend(w,$("#"+v+" form").serialize()))}).appendTo(r);var q=p("deshacer","Deshacer cambios","undo","danger");q.hide().click(function(A){A.stopPropagation();u()}).appendTo(r);d.click(function(A){A.stopPropagation();i()})}}if(!n){d.appendTo(r)}}if(j.permisos.remover){var s=p("remover","Remover","times","danger");if(!n&&typeof j.permisos.remover=="function"){s.click(function(A){A.stopPropagation();j.permisos.remover.call(this,w)})}else{s.click(function(A){A.stopPropagation();$("#"+v).remove()})}s.appendTo(r)}}else{if(typeof j.permisos.activar=="function"){e.addClass("has-error");var c=p("reactivar","Reactivar","check","success");c.click(function(A){A.stopPropagation();j.permisos.activar.call(this,w)}).appendTo(r)}}$.each(j.botones,function(A,B){if(typeof B.mostrar!="function"||B.mostrar.call(this,w)){var C=$("<a>").attr("title",B.comentario).addClass("text-muted kaccion").attr("href",(B.enlace!=undefined)?B.enlace:"Javascript:void(0);").html('<i class="fa '+x+" "+B.icono+'"></i>').hover(function(){$(this).removeClass("text-muted")},function(){$(this).addClass("text-muted")});if(B.onclick!=undefined){C.click(function(D){D.stopPropagation();B.onclick.call(this,w)})}if(B.atributos!=undefined){$.each(B.atributos,function(D,E){C.attr(D,E)})}C.appendTo(r)}});if(n){e.prependTo(j.grilla);i()}else{e.appendTo(j.grilla)}if(!j.tarjetas){e.after($("<hr>").addClass("visible-xs visible-sm"))}},cargar_paginador:function(){var d=this;if(!$(d.paginador).length){return}var e="kGrid_"+d.div.id+"_";var c=$("<div>").attr("id",e+"paginador").addClass("kGrid-paginador btn-group").appendTo(d.paginador);$("<button>").attr("id",e+"primera_pagina").attr("type","button").addClass("btn btn-default").html($("<i>").addClass("fa fa-step-backward")).appendTo(c).click(function(){$("#"+d.div.id).kGrid("pagina","primera")});$("<button>").attr("id",e+"pagina_anterior").attr("type","button").addClass("btn btn-default").html($("<i>").addClass("fa fa-backward")).appendTo(c).click(function(){$("#"+d.div.id).kGrid("pagina","anterior")});var f=$("<div>").addClass("btn btn-default kpagina").css("height",$("#"+e+"pagina_anterior").outerHeight()).appendTo(c);$("<label>").html("Página ").appendTo(f);$("<input>").attr("id",e+"pagina").attr("type","text").addClass("pagina").css("width",$("#"+e+"pagina_anterior").outerWidth()).appendTo(f).keyup(function(h){if(h.keyCode==13){h.preventDefault();var g=parseInt($("#"+e+"pagina").val());if(isNaN(g)||g<0||g>d.totalPaginas){$("#"+e+"pagina").val($("#"+e+"pagina").data("pagina"));return}if(g!=$("#"+e+"pagina").data("pagina")){$("#"+d.div.id).kGrid("pagina",g)}}});var b=$("<label>").html(" de ").appendTo(f);$("<span>").attr("id",e+"totalPaginas").appendTo(b);$("<button>").attr("id",e+"siguiente_pagina").attr("type","button").addClass("btn btn-default").html($("<i>").addClass("fa fa-forward")).appendTo(c).click(function(){$("#"+d.div.id).kGrid("pagina","siguiente")});$("<button>").attr("id",e+"ultima_pagina").attr("type","button").addClass("btn btn-default").html($("<i>").addClass("fa fa-step-forward")).appendTo(c).click(function(){$("#"+d.div.id).kGrid("pagina","ultima")})},cargar_estilos:function(){if($("#kgrid_estilos").length){return}var e={".kgrid .kbtn":["cursor: pointer"],".kgrid .kbtn:hover":["background: #ECECF0","border: 1px solid #cacaca"],".kgrid h2":["padding-bottom: 10px"],".kgrid .kscore":["width: 0","height: 0","border: 1px solid #999999","background: #ECECF0","font-size: 1.7em","margin-left: 10px","overflow: hidden","border-radius: 50%"],".kgrid .kscore p":["margin-top: 25%"],".kgrid .kscore small":["font-size: 0.5em"],".kgrid .klabel":["margin-top: 20px"],".kgrid .kaccion":["margin-left: 15px"],".kgrid .kpagina":["overflow: hidden","padding-top: 2px"],".kgrid .kpagina input":["margin: 0 5px","text-align: center"]};var b="";$.each(e,function(f,g){b+=f+"{";$.each(g,function(h,i){b+=i+";"});b+="}"});var d=$("head").find("link,style").first();var c=$("<style>").attr("id","kgrid_estilos").html(b);if(d.length){d.before(c)}else{c.prependTo("head")}},cambiar_seleccion:function(d,c){var b=this;b.seleccionados[d]=c;b.refrescar_seleccionados()},seleccionar:function(c){var b=this;b.seleccionados={};$.each(c,function(e,d){b.seleccionados[d]=true});$("."+b.div.id+"_seleccionar_row").each(function(d,e){$(e).removeAttr("checked");if(b.seleccionados[$(e).data("pk")]){$(e).prop("checked",true)}});b.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this;var c=[];$.each(b.seleccionados,function(e,d){if(d){c.push(e)
}});$(b.div).data("seleccionados",c)},agregar:function(c){var b=this;b.cargar_entrada(c)}}})();