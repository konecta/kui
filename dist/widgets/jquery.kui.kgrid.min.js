!function(a){a.kui.instances.kgrid={},a.fn.kGrid=function(b,c){return a(this).kui("grid",b,c)},a.kui.widgets.grid=function(c,d){return a.kui.list.actions({element:this,constructor:b,instances:a.kui.instances.kgrid,data:c,aux:d})};var b=function(b,c){a.kui.list.params({list:this,div:b,params:c,rows:10})};b.prototype={set_data:function(b){var c=this;a.each(b,function(a,b){c.data[a]=b})},nueva_grilla:function(){var b=this;a(b.div).addClass("kui-list"),b.table=a("<table>").addClass("table table-bordered table-striped").prependTo(a("<div>").addClass("table-responsive").prependTo(b.div)),b.tbody=a("<tbody>").attr("id",b.div.id+"_grilla").prependTo(b.table),b.seleccionable&&b.seleccionar(b.preseleccionados),a.kui.formulario.validar.reglas()},titulos:function(){var b=this;if(b.nueva_grilla(),b.mostrar_titulos){var c=a("<tr>");b.thead=a("<thead>").prependTo(b.table),a.each(b.campos,function(d,e){var f=a("<strong>");f.append(void 0!==e.titulo?e.titulo:e.nombre);var g=a("<th>").html(f).appendTo(c);b.seleccionable&&0===d&&(g.addClass("text-center"),b.checkall.attr("id",b.div.id+"_seleccionar_todo").attr("type","checkbox").change(function(){var c=a(this).is(":checked");a("."+b.div.id+"_seleccionar_row").each(function(b,d){a(d).prop("checked",c),a(d).trigger("change")})}),f.html(b.checkall))}),a("<th>").addClass("kacciones").appendTo(c),c.appendTo(b.thead)}},cargar:function(){var b=this;b.tbody?b.tbody.empty():b.nueva_grilla(),a.ajax({type:b.ajax,url:b.url,data:b.data,success:function(c){if(c.error)c.mensaje&&a.kui.messages(b.mensaje,b.tbody,c.tipoMensaje,c.mensaje);else{var d=c.respuesta.datos,e={};b.totalDatos=c.respuesta.totalDatos,b.pagina=c.respuesta.pagina,b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows),a.each(d,function(a,c){e[c[b.id]]=c,b.cargar_entrada(c)}),a(b.tbody).find("."+b.div.id+"_seleccionar_row").each(function(c,d){b.seleccionados[a(d).data("pk")]&&a(d).attr("checked","checked"),a(d).change(function(){b.cambiar_seleccion(a(d).data("pk"),a(d).is(":checked"))})}),a(b.div).data("datos",e),a(b.div).data("totalDatos",b.totalDatos),a(b.div).data("pagina",b.pagina),a(b.div).data("totalPaginas",b.totalPaginas),a("#kGrid_"+b.div.id+"_pagina").val(b.pagina).data("pagina",b.pagina),a("#kGrid_"+b.div.id+"_totalPaginas").html(b.totalPaginas),a("#kGrid_"+b.div.id+"_primera_pagina").attr("disabled",1===b.pagina),a("#kGrid_"+b.div.id+"_pagina_anterior").attr("disabled",1===b.pagina),a("#kGrid_"+b.div.id+"_ultima_pagina").attr("disabled",b.pagina===b.totalPaginas),a("#kGrid_"+b.div.id+"_siguiente_pagina").attr("disabled",b.pagina===b.totalPaginas)}"function"==typeof b.load_complete&&b.load_complete.call(this,c)},async:!1})},cargar_entrada:function(b){var c=this,d=void 0===b,e="kGrid_"+c.div.id+"_"+(d?"nuevo_"+c.nuevos:b[c.id]),f=d&&c.permisos.agregar?c.permisos.agregar:c.permisos.guardar;if(d){if(a("#"+e).is(":visible")){var g=a("#"+e).find('[data-rol="input"]:not([disabled],[readonly])').first();return void(g.length?g.focus():(c.nuevos++,c.cargar_entrada(b)))}if(!f)return void window.console.error('Para agregar entradas vacías debe configurar el permiso "agregar" o "guardar"');b={}}var h=a("<tr>").attr("id",e).attr("data-pk",b[c.id]),i=d?!0:!1;if(d||"function"!=typeof c.estado||(i=c.estado.call(this,b)),c.onclick){var j="function"==typeof c.onclick?c.onclick:function(){window.open(c.onclick,"_self")};h.addClass("kbtn").click(function(){j.call(this,b)})}else if(c.ondblclick&&("function"==typeof c.ondblclick||i&&"function"==typeof c.permisos.editar)){var k="function"==typeof c.ondblclick?c.ondblclick:function(){c.permisos.editar.call(this,b)};h.dblclick(function(){k.call(this,b)})}a.each(c.campos,function(d,e){var f=a("<td>").attr("data-cell",!0).data("campo",e).appendTo(h),g=a.kui.list.formatear(b,e.nombre,e.formato),i=a("<div>").attr("data-view",!0).data("original",g).appendTo(f);"booleano"===e.tipo?(a.kui.formulario.nuevo_elemento(!1,i,b,e),f.find("[data-rol=input]").prop("disabled",!e.editonly).attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),f.addClass("text-center")):i.html(g)});var l=a("<td>").addClass("kacciones").appendTo(h),m="fa-lg",n=function(b,d,f,g){var h=a("<a>").attr("id",e+"_"+b).addClass("text-muted kaccion").attr("title",d).attr("href",c.enlace_dummy).html('<i class="fa '+m+" fa-"+f+'"></i>').hover(function(){a(this).removeClass("text-muted").addClass("text-"+g)},function(){a(this).addClass("text-muted").removeClass("text-"+g)});return h},o=function(){if(!a("#"+e).data("formulario")){var b=a(c.div).data("datos")[a("#"+e).attr("data-pk")];b||(b={}),a("#"+e).find("[data-cell]").each(function(d,f){var g=a(f).data("campo"),h=a("<form>").attr("data-edit",!0).appendTo(f).hide();a.kui.formulario.nuevo_elemento(!1,h,b,g),"booleano"===g.tipo&&h.find("[data-rol=input]").attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),h.validate({showErrors:function(b,c){a.kui.formulario.validar.error(this,b,c)},submitHandler:function(b){a.kui.formulario.validar.fecha(b);var c=a("#"+e).data("ready");return a("#"+e).data("ready",++c),!1}})}),a("#"+e).data("formulario",!0)}a("#"+e).find("[data-view]").hide(),a("#"+e).addClass("writing"),a("#"+e).find("[data-edit]").show(),a("#"+e+"_editar").hide(),d||(a("#"+e+"_remover").hide(),a("#"+e+"_deshacer").fadeIn()),a("#"+e+"_guardar").fadeIn(),a("#"+e).find('input[data-rol="input"]:not([disabled],[readonly])').first().focus()},p=function(){a("#"+e).find("[data-edit]").hide(),a("#"+e).removeClass("writing"),a("#"+e).find("[data-view]").fadeIn(),a("#"+e+"_guardar").hide(),a("#"+e+"_deshacer").hide(),a("#"+e+"_editar").fadeIn(),a("#"+e+"_remover").fadeIn()},q=function(){p(),a("#"+e).find("[data-view]").each(function(b,c){var d=a(c).data("original"),e=a(c).parent().find("[data-rol=input]");"checkbox"===a(e).attr("type")?a(e).prop("checked",d):a(e).val(d)})};if(i){if(c.permisos.editar){var r=n("editar","Editar","pencil","primary");if("function"==typeof c.permisos.editar)r.click(function(a){a.stopPropagation(),c.permisos.editar.call(this,b)});else if(f){var s=n("guardar","Guardar","save","primary");s.hide();var t="function"==typeof f?function(a){f.call(this,a)}:function(b){a.ajax({type:"POST",url:f,data:b,success:function(){c.cargar()}})};s.click(function(c){c.stopPropagation(),a("#"+e).data("ready",0);var d=a("#"+e+" form");if(d.each(function(b,c){a(c).submit()}),a("#"+e).data("ready")===d.length){p();var f={};d.each(function(c,d){var e=a(d).serializeArray(),g="";e.length?a.each(e,function(a,b){g=f[b.name]=b.value}):g=a(d).find("input[data-rol=input]").val(),a(d).parent().find("[data-view]").each(function(b,c){var d=a(c).parent().find("[data-edit] input[data-rol=input]");a(c).empty(),a(d).is("[type=checkbox]")?(f[a(d).attr("name")]=a(d).is(":checked"),a(d).clone().prop("disabled",!0).attr("data-pk",a(c).parent().parent().data("pk")).appendTo(c)):a(c).html(g)}),f=a.extend({},b,f)}),t(f)}}).appendTo(l);var u=n("deshacer","Deshacer cambios","undo","danger");u.hide().click(function(a){a.stopPropagation(),q()}).appendTo(l),r.click(function(a){a.stopPropagation(),o()})}d||r.appendTo(l)}if(c.permisos.remover){var v=n("remover","Remover","times","danger");v.click(d||"function"!=typeof c.permisos.remover?function(b){b.stopPropagation(),a("#"+e).remove()}:function(a){a.stopPropagation(),c.permisos.remover.call(this,b)}),v.appendTo(l)}}else if("function"==typeof c.permisos.activar){h.addClass("has-error");var w=n("reactivar","Reactivar","check","success");w.click(function(a){a.stopPropagation(),c.permisos.activar.call(this,b)}).appendTo(l)}if(c.botones.length){var x;if(1===c.botones.length)x=function(b){a(b).appendTo(l)};else{var y=a("<div>").attr("id",a.kui.random_id()).addClass("kui-dropdown").appendTo("body"),z=a("<ul>").attr("role","menu").addClass("dropdown-menu").appendTo(y),A=n(a.kui.random_id(),"Acciones","angle-down","primary");A.attr("data-toggle","dropdown").attr("aria-haspopup",!0).attr("aria-expanded",!1).appendTo(l);var B=A.parent().attr("id",a.kui.random_id()).addClass("dropdown kui-dropdown"),C=z.clone().attr("aria-labelledby",A.attr("id")).appendTo(B);x=function(b){b.find("i.fa").addClass("fa-fw").removeClass("fa-lg"),a("<span>").html(" "+b.attr("title")).appendTo(b);var c=a("<li>").attr("role","presentation").appendTo(C);a(b).appendTo(c),c.clone().appendTo(z)},a(h).attr("data-toggle","context").attr("data-target","#"+y.attr("id"));var D=function(){var b=this.id;a(".kui-dropdown.open").each(function(c,d){d.id!==b&&a(d).removeClass("open")})};y.on("show.bs.context",D),B.on("show.bs.dropdown",D)}a.each(c.botones,function(d,e){if("function"!=typeof e.mostrar||e.mostrar.call(this,b)){var f=n(a.kui.random_id(),e.comentario,e.icono,"primary");f.attr("href",void 0!==e.enlace?e.enlace:c.enlace_dummy),void 0!==e.onclick&&f.click(function(a){a.stopPropagation(),e.onclick.call(this,b)}),void 0!==e.atributos&&a.each(e.atributos,function(a,b){f.attr(a,b)}),x(f)}})}d?(h.prependTo(c.tbody),o(),h.find("[data-creable]").removeAttr("readonly").removeAttr("disabled")):h.appendTo(c.tbody)},cargar_paginador:function(){var b=this;if(a(b.paginador).length){var c="kGrid_"+b.div.id+"_",d=a("<div>").attr("id",c+"paginador").addClass("kGrid-paginador btn-group").appendTo(b.paginador);a("<button>").attr("id",c+"primera_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-step-backward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","primera")}),a("<button>").attr("id",c+"pagina_anterior").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-backward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","anterior")});var e=a("<div>").addClass("btn btn-default kpagina").css("height",a("#"+c+"pagina_anterior").outerHeight()).appendTo(d);a("<label>").html("Página ").appendTo(e),a("<input>").attr("id",c+"pagina").attr("type","text").addClass("pagina").css("width",a("#"+c+"pagina_anterior").outerWidth()).appendTo(e).keyup(function(d){if(13===d.keyCode){d.preventDefault();var e=parseInt(a("#"+c+"pagina").val());if(isNaN(e)||0>e||e>b.totalPaginas)return void a("#"+c+"pagina").val(a("#"+c+"pagina").data("pagina"));e!==a("#"+c+"pagina").data("pagina")&&a("#"+b.div.id).kGrid("pagina",e)}});var f=a("<label>").html(" de ").appendTo(e);a("<span>").attr("id",c+"totalPaginas").appendTo(f),a("<button>").attr("id",c+"siguiente_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-forward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","siguiente")}),a("<button>").attr("id",c+"ultima_pagina").attr("type","button").addClass("btn btn-default").html(a("<i>").addClass("fa fa-step-forward")).appendTo(d).click(function(){a("#"+b.div.id).kGrid("pagina","ultima")})}},cambiar_seleccion:function(a,b){var c=this;c.seleccionados[a]=b,c.refrescar_seleccionados()},seleccionar:function(b){var c=this;c.seleccionados={},a.each(b,function(a,b){c.seleccionados[b]=!0}),a("."+c.div.id+"_seleccionar_row").each(function(b,d){a(d).removeAttr("checked"),c.seleccionados[a(d).data("pk")]&&a(d).prop("checked",!0)}),c.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this,c=[];a.each(b.seleccionados,function(a,b){b&&c.push(a)}),a(b.div).data("seleccionados",c);var d=a(b.div).find("."+b.div.id+"_seleccionar_row:checked").length;b.checkall.prop("checked",d>0&&a(b.div).find("."+b.div.id+"_seleccionar_row").length===d)},agregar:function(a){var b=this;b.cargar_entrada(a)}}}(jQuery);