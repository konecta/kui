!function(a){a.kui.instances.kgrid={},a.fn.kGrid=function(b,c){return a(this).kui("grid",b,c)},a.kui.widgets.grid=function(c,d){return a.kui.list.actions({element:this,constructor:b,instances:a.kui.instances.kgrid,data:c,aux:d})};var b=function(b,c){a.kui.list.params({list:this,div:b,params:c,rows:10})};b.prototype={name:"grid",setData:function(b){var c=this;a.each(b,function(a,b){c.data[a]=b})},newGrid:function(){var b=this;b.haveActions=b.botones.length||b.permisos[a.kui.i18n.add]||b.permisos[a.kui.i18n.edit]||b.permisos[a.kui.i18n.save]||b.permisos[a.kui.i18n.activate]||b.permisos[a.kui.i18n.remove]?!0:!1,a(b.div).addClass("kui-list"),b.table=a("<table>").addClass("table table-bordered table-striped").prependTo(a("<div>").addClass("table-responsive").prependTo(b.div)),b.tbody=a("<tbody>").attr("id",b.div.id+"_grilla").prependTo(b.table),b.seleccionable&&b.seleccionar(b.preseleccionados)},titulos:function(){var b=this;if(b.newGrid(),b.showTitles){var c=a("<tr>");b.thead=a("<thead>").prependTo(b.table),a.each(b.campos,function(d,e){var f=a("<strong>");void 0!==e.titulo?f.append(e.titulo):f.append(e.nombre);var g=a("<th>").html(f).appendTo(c);e.oculto&&g.addClass("hidden"),b.seleccionable&&0===d&&(g.addClass("text-center"),b.checkall.attr("id",b.div.id+"_seleccionar_todo").attr("type","checkbox").change(function(){var c=a(this).is(":checked");a("."+b.div.id+"_seleccionar_row").each(function(b,d){a(d).prop("checked",c),a(d).trigger("change")})}),f.html(b.checkall))}),b.haveActions&&a("<th>").addClass("kacciones").appendTo(c),c.appendTo(b.thead)}},load:function(){var b=this;b.tbody?b.tbody.empty():b.newGrid();var c=a.kui.data.source({source:b.source,sourceAjax:b.ajax,sourceData:b.data,key:"respuesta",message:b.mensaje,messageContainer:b.div});if(c){var d=c.datos,e={};b.totalDatos=parseInt(c.totalDatos),b.pagina=parseInt(c.pagina),b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows),a.each(d,function(a,c){e[c[b.id]]=c,b.load_entrada(c)}),a(b.tbody).find("."+b.div.id+"_seleccionar_row").each(function(c,d){b.seleccionados[a(d).data("pk")]&&a(d).attr("checked","checked"),a(d).change(function(){b.cambiar_seleccion(a(d).data("pk"),a(d).is(":checked"))})}),a(b.div).data("datos",e),a(b.div).data("totalDatos",b.totalDatos),a(b.div).data("pagina",b.pagina),a(b.div).data("totalPaginas",b.totalPaginas),a.kui.list.reloadPager(b)}"function"==typeof b.loadComplete&&b.loadComplete.call(this,c)},load_entrada:function(b){var c=this,d=void 0===b,e="kGrid_"+c.div.id+"_"+(d?"nuevo_"+c.nuevos:b[c.id]),f=d&&c.permisos[a.kui.i18n.add]?c.permisos[a.kui.i18n.add]:c.permisos[a.kui.i18n.save];if(d){if(a("#"+e).is(":visible")){var g=!0;return a("#"+e).find("form").each(function(b,c){g=g&&a(c).valid()}),void(g?(c.nuevos++,c.load_entrada(b)):a("#"+e).find('[data-rol="input"]:not([disabled],[readonly])').first().focus())}if(!f)return void window.console.error('Para agregar entradas vac√≠as debe configurar el permiso "agregar" o "guardar"');b={}}var h=a("<tr>").attr("id",e).attr("data-pk",d?"new-"+c.nuevos+"-"+a.kui.randomId():b[c.id]),i=d?!0:!1;if(d?h.attr("data-new",!0):"function"==typeof c.estado&&(i=c.estado.call(this,b)),c.onclick){var j="function"==typeof c.onclick?c.onclick:function(){window.open(c.onclick,"_self")};h.addClass("kbtn").click(function(){j.call(this,b)})}else if(c.ondblclick&&("function"==typeof c.ondblclick||i&&"function"==typeof c.permisos[a.kui.i18n.edit])){var k="function"==typeof c.ondblclick?c.ondblclick:function(){c.permisos[a.kui.i18n.edit].call(this,b)};h.dblclick(function(){k.call(this,b)})}a.each(c.campos,function(d,e){var f=a("<td>").attr("data-cell",!0).data("campo",e).appendTo(h),g=a.kui.data.format(b,e.nombre,e.formato,e.opciones,!0),i=a("<div>").attr("data-view",!0).data("original",g).appendTo(f);e.oculto&&f.addClass("hidden"),"booleano"===e.tipo?(a.kui.form.newElement(!1,i,b,e),f.find("[data-rol=input]").prop("disabled",!e.editonly).attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),f.addClass("text-center"),i.removeClass("checkbox")):i.html(g)}),c.haveActions&&c.actions(b,e,i,f,h,d),d?(h.prependTo(c.tbody),c.enableEdit(e,d)):h.appendTo(c.tbody)},cambiar_seleccion:function(a,b){var c=this;c.seleccionados[a]=b,c.refrescar_seleccionados()},seleccionar:function(b){var c=this;c.seleccionados={},a.each(b,function(a,b){c.seleccionados[b]=!0}),a("."+c.div.id+"_seleccionar_row").each(function(b,d){a(d).removeAttr("checked"),c.seleccionados[a(d).data("pk")]&&a(d).prop("checked",!0)}),c.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this,c=[];a.each(b.seleccionados,function(a,b){b&&c.push(a)}),a(b.div).data("seleccionados",c);var d=a(b.div).find("."+b.div.id+"_seleccionar_row:checked").length;b.checkall.prop("checked",d>0&&a(b.div).find("."+b.div.id+"_seleccionar_row").length===d)},agregar:function(a){var b=this;b.load_entrada(a)},enableEdit:function(b,c){var d=this;if(!a("#"+b).data("formulario")){var e=a(d.div).data("datos")[a("#"+b).attr("data-pk")];e||(e={}),a("#"+b).find("[data-cell]").each(function(c,f){var g=a(f).data("campo"),h=a("<form>").attr("data-edit",!0).appendTo(f).hide();a.kui.form.newElement(!1,h,e,g,a("#"+b).data("new")),"booleano"===g.tipo&&h.removeClass("checkbox").find("[data-rol=input]").attr("data-pk",e[d.id]).dblclick(function(a){a.stopPropagation()}),a.kui.form.validate.add({form:h,submit:function(){var c=a("#"+b).data("ready");a("#"+b).data("ready",++c)}})}),a("#"+b).data("formulario",!0)}a("#"+b).find("[data-cell]").each(function(b,c){a(c).css({width:a(c).outerWidth(),height:a(c).outerHeight()})}),a("#"+b).find("[data-view]").hide(),a("#"+b).addClass("writing"),a("#"+b).find("[data-edit]").show(),a("#"+b+"_editar").hide(),c||(a("#"+b+"_remover").hide(),a("#"+b+"_deshacer").fadeIn()),a("#"+b+"_guardar").fadeIn(),a("#"+b).find('[data-rol="input"]:not([disabled],[readonly])').first().focus()},actions:function(b,c,d,e,f,g){var h=this,i=a("<td>").addClass("kacciones").appendTo(f),j="fa-lg",k=function(b,d,e,f){var g=a("<a>").attr("id",c+"_"+b).addClass("text-muted kaccion").attr("title",d).attr("href",a.kui.dummyLink).html('<i class="fa '+j+" fa-"+e+'"></i>').hover(function(){a(this).removeClass("text-muted").addClass("text-"+f)},function(){a(this).addClass("text-muted").removeClass("text-"+f)});return g},l=function(){a("#"+c).find("[data-edit]").hide(),a("#"+c).removeClass("writing"),a("#"+c).find("[data-view]").fadeIn(),a("#"+c).find("[data-cell]").removeAttr("style"),a("#"+c+"_guardar").hide(),a("#"+c+"_deshacer").hide(),a("#"+c+"_editar").fadeIn(),a("#"+c+"_remover").fadeIn()},m=function(){l(),a("#"+c).find("[data-view]").each(function(b,c){var d=a(c).data("original"),e=a(c).parent().find("[data-rol=input]");"checkbox"===a(e).attr("type")?a(e).prop("checked",d):a(e).val(d)})};if(d){var n=k("editar",a.kui.i18n.editMsg,"pencil","primary");if(h.permisos[a.kui.i18n.edit]&&!g&&"function"==typeof h.permisos[a.kui.i18n.edit])n.click(function(c){c.stopPropagation(),h.permisos[a.kui.i18n.edit].call(this,b)}).appendTo(i);else if(e){var o=k("guardar",a.kui.i18n.saveMsg,"save","primary");o.hide();var p="function"==typeof e?function(a,b){e.call(this,a,b)}:function(b){a.ajax({type:"POST",url:e,data:b,success:function(){h.load()}})};o.click(function(b){b.stopPropagation(),a("#"+c).data("ready",0);var d=a("#"+c+" form");if(d.each(function(b,c){a(c).submit()}),a("#"+c).data("ready")===d.length){l();var e={};d.each(function(b,c){var d=a(c).serializeArray(),f="";d.length?a.each(d,function(a,b){f=e[b.name]=b.value}):f=a(c).find("[data-rol=input]").val(),a(c).parent().find("[data-view]").each(function(b,c){var d=a(c).parent().find("[data-edit] [data-rol=input]");a(c).empty(),a(d).is("[type=checkbox]")?(e[a(d).attr("name")]=a(d).is(":checked"),a(d).clone().prop("disabled",!0).attr("data-pk",a(c).parent().parent().data("pk")).appendTo(c)):a(d).is("select")?a(c).html(a(d).find('option[value="'+f+'"]').text()):a(c).html(f)})}),p(e,a("#"+c)),a("#"+c).data("new")&&(a(h.div).data("datos")[a("#"+c).data("pk")]=e)}}).appendTo(i);var q=k("deshacer","Deshacer cambios","undo","danger");q.hide().click(function(a){a.stopPropagation(),m()}).appendTo(i),g||n.appendTo(i).click(function(a){a.stopPropagation(),h.enableEdit(c,g)})}if(h.permisos[a.kui.i18n.remove]||g){var r=k("remover",a.kui.i18n.removeMsg,"times","danger");g||"function"!=typeof h.permisos[a.kui.i18n.remove]?r.click(function(b){b.stopPropagation(),a(h.div).data("datos")[a("#"+c).data("pk")]=null,delete a(h.div).data("datos")[a("#"+c).data("pk")],a("#"+c).remove()}):r.click(function(c){c.stopPropagation(),h.permisos[a.kui.i18n.remove].call(this,b)}),r.appendTo(i)}}else if("function"==typeof h.permisos[a.kui.i18n.activate]){f.addClass("has-error");var s=k("reactivar",a.kui.i18n.activateMsg,"check","success");s.click(function(c){c.stopPropagation(),h.permisos[a.kui.i18n.activate].call(this,b)}).appendTo(i)}if(h.botones.length){var t;if(1===h.botones.length)t=function(b){a(b).appendTo(i)};else{var u=a("<div>").attr("id",a.kui.randomId()).addClass("kui-dropdown").appendTo("body"),v=a("<ul>").attr("role","menu").addClass("dropdown-menu").appendTo(u),w=k(a.kui.randomId(),"Acciones","angle-down","primary");w.attr("data-toggle","dropdown").attr("aria-haspopup",!0).attr("aria-expanded",!1).appendTo(i);var x=w.parent().attr("id",a.kui.randomId()).addClass("dropdown kui-dropdown"),y=v.clone().attr("aria-labelledby",w.attr("id")).appendTo(x);t=function(b){b.find("i.fa").addClass("fa-fw").removeClass("fa-lg"),a("<span>").html(" "+b.attr("title")).appendTo(b);var c=a("<li>").attr("role","presentation").appendTo(y);a(b).appendTo(c),c.clone().appendTo(v)},a(f).attr("data-toggle","context").attr("data-target","#"+u.attr("id"));var z=function(){var b=this.id;a(".kui-dropdown.open").each(function(c,d){d.id!==b&&a(d).removeClass("open")}),h.table.parent().addClass("kui-grid-dropdown-open")};u.on("show.bs.context",z),x.on("show.bs.dropdown",z);var A=function(){h.table.parent().removeClass("kui-grid-dropdown-open")};u.on("hide.bs.context",A),x.on("hide.bs.dropdown",A)}a.each(h.botones,function(c,d){if("function"!=typeof d.mostrar||d.mostrar.call(this,b)){var e=k(a.kui.randomId(),d.comentario,d.icono,"primary");e.attr("href",void 0!==d.enlace?d.enlace:a.kui.dummyLink),void 0!==d.onclick&&e.click(function(a){a.stopPropagation(),d.onclick.call(this,b)}),void 0!==d.atributos&&a.each(d.atributos,function(a,b){e.attr(a,b)}),t(e)}})}}}}(jQuery);