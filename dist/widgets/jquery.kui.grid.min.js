!function(a){a.kui.instances.kgrid={},a.fn.kGrid=function(b,c){return a(this).kui("grid",b,c)},a.kui.widgets.grid=function(c,d){return a.kui.list.actions({element:this,constructor:b,instances:a.kui.instances.kgrid,data:c,aux:d})};var b=function(b,c){a.kui.list.params({list:this,div:b,params:c,rows:10})};b.prototype={name:"grid",setData:function(b){var c=this;a.each(b,function(a,b){c.data[a]=b})},nueva_grilla:function(){var b=this;a(b.div).addClass("kui-list"),b.table=a("<table>").addClass("table table-bordered table-striped").prependTo(a("<div>").addClass("table-responsive").prependTo(b.div)),b.tbody=a("<tbody>").attr("id",b.div.id+"_grilla").prependTo(b.table),b.seleccionable&&b.seleccionar(b.preseleccionados),a.kui.form.validar.reglas()},titulos:function(){var b=this;if(b.nueva_grilla(),b.showTitles){var c=a("<tr>");b.thead=a("<thead>").prependTo(b.table),a.each(b.campos,function(d,e){var f=a("<strong>");void 0!==e.titulo?f.append(e.titulo):f.append(e.nombre);var g=a("<th>").html(f).appendTo(c);e.oculto&&g.addClass("hidden"),b.seleccionable&&0===d&&(g.addClass("text-center"),b.checkall.attr("id",b.div.id+"_seleccionar_todo").attr("type","checkbox").change(function(){var c=a(this).is(":checked");a("."+b.div.id+"_seleccionar_row").each(function(b,d){a(d).prop("checked",c),a(d).trigger("change")})}),f.html(b.checkall))}),a("<th>").addClass("kacciones").appendTo(c),c.appendTo(b.thead)}},load:function(){var b=this;b.tbody?b.tbody.empty():b.nueva_grilla(),a.ajax({type:b.ajax,url:b.source,data:b.data,success:function(c){if(c.error)c.mensaje&&a.kui.messages(b.mensaje,b.div,c.tipoMensaje,c.mensaje);else{var d=c.respuesta.datos,e={};b.totalDatos=parseInt(c.respuesta.totalDatos),b.pagina=parseInt(c.respuesta.pagina),b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows),a.each(d,function(a,c){e[c[b.id]]=c,b.load_entrada(c)}),a(b.tbody).find("."+b.div.id+"_seleccionar_row").each(function(c,d){b.seleccionados[a(d).data("pk")]&&a(d).attr("checked","checked"),a(d).change(function(){b.cambiar_seleccion(a(d).data("pk"),a(d).is(":checked"))})}),a(b.div).data("datos",e),a(b.div).data("totalDatos",b.totalDatos),a(b.div).data("pagina",b.pagina),a(b.div).data("totalPaginas",b.totalPaginas),a.kui.list.reloadPager(b)}"function"==typeof b.loadComplete&&b.loadComplete.call(this,c)},async:!1})},load_entrada:function(b){var c=this,d=void 0===b,e="kGrid_"+c.div.id+"_"+(d?"nuevo_"+c.nuevos:b[c.id]),f=d&&c.permisos[a.kui.i18n.add]?c.permisos[a.kui.i18n.add]:c.permisos.guardar;if(d){if(a("#"+e).is(":visible")){var g=!0;return a("#"+e).find("form").each(function(b,c){g=g&&a(c).valid()}),void(g?(c.nuevos++,c.load_entrada(b)):a("#"+e).find('[data-rol="input"]:not([disabled],[readonly])').first().focus())}if(!f)return void window.console.error('Para agregar entradas vac√≠as debe configurar el permiso "agregar" o "guardar"');b={}}var h=a("<tr>").attr("id",e).attr("data-pk",d?"new-"+c.nuevos+"-"+a.kui.randomId():b[c.id]),i=d?!0:!1;if(d?h.attr("data-new",!0):"function"==typeof c.estado&&(i=c.estado.call(this,b)),c.onclick){var j="function"==typeof c.onclick?c.onclick:function(){window.open(c.onclick,"_self")};h.addClass("kbtn").click(function(){j.call(this,b)})}else if(c.ondblclick&&("function"==typeof c.ondblclick||i&&"function"==typeof c.permisos.editar)){var k="function"==typeof c.ondblclick?c.ondblclick:function(){c.permisos.editar.call(this,b)};h.dblclick(function(){k.call(this,b)})}a.each(c.campos,function(d,e){var f=a("<td>").attr("data-cell",!0).data("campo",e).appendTo(h),g=a.kui.data.format(b,e.nombre,e.formato,e.opciones,!0),i=a("<div>").attr("data-view",!0).data("original",g).appendTo(f);e.oculto&&f.addClass("hidden"),"booleano"===e.tipo?(a.kui.form.newElement(!1,i,b,e),f.find("[data-rol=input]").prop("disabled",!e.editonly).attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),f.addClass("text-center"),i.removeClass("checkbox")):i.html(g)});var l=a("<td>").addClass("kacciones").appendTo(h),m="fa-lg",n=function(b,c,d,f){var g=a("<a>").attr("id",e+"_"+b).addClass("text-muted kaccion").attr("title",c).attr("href",a.kui.dummyLink).html('<i class="fa '+m+" fa-"+d+'"></i>').hover(function(){a(this).removeClass("text-muted").addClass("text-"+f)},function(){a(this).addClass("text-muted").removeClass("text-"+f)});return g},o=function(){if(!a("#"+e).data("formulario")){var b=a(c.div).data("datos")[a("#"+e).attr("data-pk")];b||(b={}),a("#"+e).find("[data-cell]").each(function(d,f){var g=a(f).data("campo"),h=a("<form>").attr("data-edit",!0).appendTo(f).hide();a.kui.form.newElement(!1,h,b,g,a("#"+e).data("new")),"booleano"===g.tipo&&h.removeClass("checkbox").find("[data-rol=input]").attr("data-pk",b[c.id]).dblclick(function(a){a.stopPropagation()}),h.validate({showErrors:function(b,c){a.kui.form.validar.error(this,b,c)},submitHandler:function(b){a.kui.form.validar.fecha(b);var c=a("#"+e).data("ready");return a("#"+e).data("ready",++c),!1}})}),a("#"+e).data("formulario",!0)}a("#"+e).find("[data-cell]").each(function(b,c){a(c).css({width:a(c).outerWidth(),height:a(c).outerHeight()})}),a("#"+e).find("[data-view]").hide(),a("#"+e).addClass("writing"),a("#"+e).find("[data-edit]").show(),a("#"+e+"_editar").hide(),d||(a("#"+e+"_remover").hide(),a("#"+e+"_deshacer").fadeIn()),a("#"+e+"_guardar").fadeIn(),a("#"+e).find('[data-rol="input"]:not([disabled],[readonly])').first().focus()},p=function(){a("#"+e).find("[data-edit]").hide(),a("#"+e).removeClass("writing"),a("#"+e).find("[data-view]").fadeIn(),a("#"+e).find("[data-cell]").removeAttr("style"),a("#"+e+"_guardar").hide(),a("#"+e+"_deshacer").hide(),a("#"+e+"_editar").fadeIn(),a("#"+e+"_remover").fadeIn()},q=function(){p(),a("#"+e).find("[data-view]").each(function(b,c){var d=a(c).data("original"),e=a(c).parent().find("[data-rol=input]");"checkbox"===a(e).attr("type")?a(e).prop("checked",d):a(e).val(d)})};if(i){var r=n("editar",a.kui.i18n.editMsg,"pencil","primary");if(c.permisos.editar&&!d&&"function"==typeof c.permisos.editar)r.click(function(a){a.stopPropagation(),c.permisos.editar.call(this,b)});else if(f){var s=n("guardar",a.kui.i18n.saveMsg,"save","primary");s.hide();var t="function"==typeof f?function(a,b){f.call(this,a,b)}:function(b){a.ajax({type:"POST",url:f,data:b,success:function(){c.load()}})};s.click(function(b){b.stopPropagation(),a("#"+e).data("ready",0);var d=a("#"+e+" form");if(d.each(function(b,c){a(c).submit()}),a("#"+e).data("ready")===d.length){p();var f={};d.each(function(b,c){var d=a(c).serializeArray(),e="";d.length?a.each(d,function(a,b){e=f[b.name]=b.value}):e=a(c).find("[data-rol=input]").val(),a(c).parent().find("[data-view]").each(function(b,c){var d=a(c).parent().find("[data-edit] [data-rol=input]");a(c).empty(),a(d).is("[type=checkbox]")?(f[a(d).attr("name")]=a(d).is(":checked"),a(d).clone().prop("disabled",!0).attr("data-pk",a(c).parent().parent().data("pk")).appendTo(c)):a(d).is("select")?a(c).html(a(d).find('option[value="'+e+'"]').text()):a(c).html(e)})}),t(f,a("#"+e)),a("#"+e).data("new")&&(a(c.div).data("datos")[a("#"+e).data("pk")]=f)}}).appendTo(l);var u=n("deshacer","Deshacer cambios","undo","danger");u.hide().click(function(a){a.stopPropagation(),q()}).appendTo(l),r.click(function(a){a.stopPropagation(),o()})}if(d||r.appendTo(l),c.permisos.remover||d){var v=n("remover",a.kui.i18n.removeMsg,"times","danger");d||"function"!=typeof c.permisos.remover?v.click(function(b){b.stopPropagation(),a(c.div).data("datos")[a("#"+e).data("pk")]=null,delete a(c.div).data("datos")[a("#"+e).data("pk")],a("#"+e).remove()}):v.click(function(a){a.stopPropagation(),c.permisos.remover.call(this,b)}),v.appendTo(l)}}else if("function"==typeof c.permisos.activar){h.addClass("has-error");var w=n("reactivar",a.kui.i18n.activateMsg,"check","success");w.click(function(a){a.stopPropagation(),c.permisos.activar.call(this,b)}).appendTo(l)}if(c.botones.length){var x;if(1===c.botones.length)x=function(b){a(b).appendTo(l)};else{var y=a("<div>").attr("id",a.kui.randomId()).addClass("kui-dropdown").appendTo("body"),z=a("<ul>").attr("role","menu").addClass("dropdown-menu").appendTo(y),A=n(a.kui.randomId(),"Acciones","angle-down","primary");A.attr("data-toggle","dropdown").attr("aria-haspopup",!0).attr("aria-expanded",!1).appendTo(l);var B=A.parent().attr("id",a.kui.randomId()).addClass("dropdown kui-dropdown"),C=z.clone().attr("aria-labelledby",A.attr("id")).appendTo(B);x=function(b){b.find("i.fa").addClass("fa-fw").removeClass("fa-lg"),a("<span>").html(" "+b.attr("title")).appendTo(b);var c=a("<li>").attr("role","presentation").appendTo(C);a(b).appendTo(c),c.clone().appendTo(z)},a(h).attr("data-toggle","context").attr("data-target","#"+y.attr("id"));var D=function(){var b=this.id;a(".kui-dropdown.open").each(function(c,d){d.id!==b&&a(d).removeClass("open")}),c.table.parent().addClass("kui-grid-dropdown-open")};y.on("show.bs.context",D),B.on("show.bs.dropdown",D);var E=function(){c.table.parent().removeClass("kui-grid-dropdown-open")};y.on("hide.bs.context",E),B.on("hide.bs.dropdown",E)}a.each(c.botones,function(c,d){if("function"!=typeof d.mostrar||d.mostrar.call(this,b)){var e=n(a.kui.randomId(),d.comentario,d.icono,"primary");e.attr("href",void 0!==d.enlace?d.enlace:a.kui.dummyLink),void 0!==d.onclick&&e.click(function(a){a.stopPropagation(),d.onclick.call(this,b)}),void 0!==d.atributos&&a.each(d.atributos,function(a,b){e.attr(a,b)}),x(e)}})}d?(h.prependTo(c.tbody),o()):h.appendTo(c.tbody)},cambiar_seleccion:function(a,b){var c=this;c.seleccionados[a]=b,c.refrescar_seleccionados()},seleccionar:function(b){var c=this;c.seleccionados={},a.each(b,function(a,b){c.seleccionados[b]=!0}),a("."+c.div.id+"_seleccionar_row").each(function(b,d){a(d).removeAttr("checked"),c.seleccionados[a(d).data("pk")]&&a(d).prop("checked",!0)}),c.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this,c=[];a.each(b.seleccionados,function(a,b){b&&c.push(a)}),a(b.div).data("seleccionados",c);var d=a(b.div).find("."+b.div.id+"_seleccionar_row:checked").length;b.checkall.prop("checked",d>0&&a(b.div).find("."+b.div.id+"_seleccionar_row").length===d)},agregar:function(a){var b=this;b.load_entrada(a)}}}(jQuery);