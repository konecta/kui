!function(a){a.kui.instances.kcard={},a.kui.widgets.cards=function(c,d){return a.kui.list.actions({element:this,constructor:b,instances:a.kui.instances.kcard,data:c,aux:d})};var b=function(b,c){a.kui.list.params({list:this,div:b,params:c,rows:5})};b.prototype={name:"cards",set_data:function(b){var c=this;a.each(b,function(a,b){c.data[a]=b})},nueva_grilla:function(){var b=this;a(b.div).addClass("kui-list form-horizontal"),b.contenido=a("<div>").attr("id",b.div.id+"_grilla").prependTo(b.div),b.seleccionable&&b.seleccionar(b.preseleccionados)},titulos:function(){},cargar:function(){var b=this;b.contenido?b.contenido.empty():b.nueva_grilla(),a.ajax({type:b.ajax,url:b.url,data:b.data,success:function(c){if(c.error)c.mensaje&&a.kui.messages(b.mensaje,b.contenido,c.tipoMensaje,c.mensaje);else{var d=c.respuesta.datos,e={};b.totalDatos=parseInt(c.respuesta.totalDatos),b.pagina=parseInt(c.respuesta.pagina),b.totalPaginas=Math.ceil(b.totalDatos/b.data.rows),b.grilla=a("<div>").addClass("kCard").prependTo(b.contenido),a.each(d,function(a,c){e[c[b.id]]=c,b.cargar_entrada(c)}),a(b.grilla).find("."+b.div.id+"_seleccionar_row").each(function(c,d){b.seleccionados[a(d).data("pk")]&&a(d).attr("checked","checked"),a(d).change(function(){b.cambiar_seleccion(a(d).data("pk"),a(d).is(":checked"))})}),b.grilla.find(".kscore").each(function(b,c){var d=.8*parseInt(a(c).parent().parent().parent().height());a(c).css("width",d),a(c).css("height",d)}),b.grilla.find(".kacciones,.kscores").each(function(b,c){var d=a(c).parent().parent().height()-a(c).height(),e=a(c).next();e.hasClass("kscores")&&!e.is(":empty")?a(c).css("font-size","0.5em"):d/=2,d>0&&a(c).css("padding-top",d)}),a(b.div).data("datos",e),a(b.div).data("totalDatos",b.totalDatos),a(b.div).data("pagina",b.pagina),a(b.div).data("totalPaginas",b.totalPaginas),a.kui.list.refrescar_paginador(b)}"function"==typeof b.load_complete&&b.load_complete.call(this,c)},async:!1})},cargar_entrada:function(b){var c=this,d=void 0===b,e="kCard_"+c.div.id+"_"+(d?"nuevo_"+c.nuevos:b[c.id]),f=d&&c.permisos[a.kui.i18n.inputs.add]?c.permisos[a.kui.i18n.inputs.add]:c.permisos.guardar,g=a("<div>").attr("id",e).attr("data-pk",b[c.id]).addClass("form-group well"),h=d?!0:!1;if(d||"function"!=typeof c.estado||(h=c.estado.call(this,b)),c.onclick){var i="function"==typeof c.onclick?c.onclick:function(){window.open(c.onclick,"_self")};g.addClass("kbtn").click(function(){i.call(this,b)})}else if(c.ondblclick&&("function"==typeof c.ondblclick||h&&"function"==typeof c.permisos.editar)){var j="function"==typeof c.ondblclick?c.ondblclick:function(){c.permisos.editar.call(this,b)};g.dblclick(function(){j.call(this,b)})}var k=a(f?"<form>":"<div>").addClass("col-sm-7").appendTo(g),l=a("<div>").addClass("text-right col-sm-5").appendTo(g),m=a("<div>").addClass("pull-right").addClass("kacciones").appendTo(l),n=a("<div>").addClass("kscores pull-right").appendTo(l);a.each(c.campos,function(c,d){var e;if("score"!==d.tipo){var f=6,g="<p>";("destacado"===d.tipo||"encabezado"===d.tipo)&&(f=12),"encabezado"===d.tipo&&(g="<h2>"),e=a(g).addClass("col-sm-"+f).appendTo(k)}else e=a("<p>").appendTo(a("<div>").addClass("text-center pull-left kscore").appendTo(n));e.html(a.kui.data.format(b,d.nombre,d.formato)),d.titulo&&""!==d.titulo&&("score"!==d.tipo?a("<label>").addClass("text-muted").html(d.titulo+"&nbsp; &nbsp;").prependTo(e):(a("<br>").appendTo(e),a("<small>").html(d.titulo).appendTo(e))),"function"==typeof d.formato&&(b[d.nombre]=d.formato.call(this,b[d.nombre],b))});var o="fa-3x",p=function(b,c,d,f){var g=a("<a>").attr("id",e+"_"+b).addClass("text-muted kaccion").attr("title",c).attr("href",a.kui.dummyLink).html('<i class="fa '+o+" fa-"+d+'"></i>').hover(function(){a(this).removeClass("text-muted").addClass("text-"+f)},function(){a(this).addClass("text-muted").removeClass("text-"+f)});return g},q=function(){a("#"+e+" form").find("input[readonly]").each(function(b,c){("true"!==a(c).attr("data-disabled")&&"true"!==a(c).attr("data-readonly")||d&&a(c).attr("data-creable"))&&a(c).removeAttr("readonly").removeAttr("disabled").attr("data-editando",!0).keyup(function(b){13===b.keyCode&&(b.preventDefault(),a("#"+e+" form").submit())})}),a("#"+e+"_editar").hide(),d||(a("#"+e+"_remover").hide(),a("#"+e+"_deshacer").fadeIn()),a("#"+e+"_guardar").fadeIn(),a("#"+e).find("input[data-editando]").first().focus()},r=function(){a("#"+e+" form").find("input[data-editando]").each(function(b,c){a(c).attr("readonly","false"!==a(c).attr("data-readonly")).removeAttr("data-editando").unbind("keyup"),"checkbox"===a(c).attr("type")&&a(c).attr("disabled","false"!==a(c).attr("data-disabled"))}),a("#"+e+"_guardar").hide(),a("#"+e+"_deshacer").hide(),a("#"+e+"_editar").fadeIn(),a("#"+e+"_remover").fadeIn()},s=function(){var b=a(c.div).data("datos")[a("#"+e).attr("data-pk")],d=a("#"+e+" form").find("input[data-editando]");r(),d.each(function(c,d){"checkbox"===a(d).attr("type")?a(d).prop("checked",b[a(d).attr("name")]):a(d).val(b[a(d).attr("name")])})};if(h){if(c.permisos.editar){var t=p("editar","Editar","pencil","primary");if("function"==typeof c.permisos.editar)t.click(function(a){a.stopPropagation(),c.permisos.editar.call(this,b)});else if(f){var u=p("guardar","Guardar","save","primary");u.hide();var v="function"==typeof f?function(a){f.call(this,a)}:function(b){a.ajax({type:"POST",url:f,data:b,success:function(){c.cargar()}})};a.kui.form.validar.reglas(),a(k).validate({showErrors:function(b,c){a.kui.form.validar.error(this,b,c)},submitHandler:function(c){a.kui.form.validar.fecha(c),r();var d={};return a.each(a("#"+e+" form").serializeArray(),function(a,b){d[b.name]=b.value}),a.each(a("#"+e+" form input[data-rol=input][type=checkbox]"),function(b,c){d[a(c).attr("name")]=a(c).is(":checked")}),d=a.extend({},b,d),v(d),!1}}),u.click(function(b){b.stopPropagation(),a("#"+e+" form").submit()}).appendTo(m);var w=p("deshacer","Deshacer cambios","undo","danger");w.hide().click(function(a){a.stopPropagation(),s()}).appendTo(m),t.click(function(a){a.stopPropagation(),q()})}d||t.appendTo(m)}if(c.permisos.remover){var x=p("remover","Remover","times","danger");x.click(d||"function"!=typeof c.permisos.remover?function(b){b.stopPropagation(),a("#"+e).remove()}:function(a){a.stopPropagation(),c.permisos.remover.call(this,b)}),x.appendTo(m)}}else if("function"==typeof c.permisos.activar){g.addClass("has-error");var y=p("reactivar","Reactivar","check","success");y.click(function(a){a.stopPropagation(),c.permisos.activar.call(this,b)}).appendTo(m)}if(c.botones.length){var z=function(b){a(b).appendTo(m)};a.each(c.botones,function(c,d){if("function"!=typeof d.mostrar||d.mostrar.call(this,b)){var e=p(a.kui.randomId(),d.comentario,d.icono,"primary");e.attr("href",void 0!==d.enlace?d.enlace:a.kui.dummyLink),void 0!==d.onclick&&e.click(function(a){a.stopPropagation(),d.onclick.call(this,b)}),void 0!==d.atributos&&a.each(d.atributos,function(a,b){e.attr(a,b)}),z(e)}})}d?(g.prependTo(c.grilla),q()):g.appendTo(c.grilla)},cambiar_seleccion:function(a,b){var c=this;c.seleccionados[a]=b,c.refrescar_seleccionados()},seleccionar:function(b){var c=this;c.seleccionados={},a.each(b,function(a,b){c.seleccionados[b]=!0}),a("."+c.div.id+"_seleccionar_row").each(function(b,d){a(d).removeAttr("checked"),c.seleccionados[a(d).data("pk")]&&a(d).prop("checked",!0)}),c.refrescar_seleccionados()},refrescar_seleccionados:function(){var b=this,c=[];a.each(b.seleccionados,function(a,b){b&&c.push(a)}),a(b.div).data("seleccionados",c);var d=a(b.div).find("."+b.div.id+"_seleccionar_row:checked").length;b.checkall.prop("checked",d>0&&a(b.div).find("."+b.div.id+"_seleccionar_row").length===d)},agregar:function(a){var b=this;b.cargar_entrada(a)}}}(jQuery);